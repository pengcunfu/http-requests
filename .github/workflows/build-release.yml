name: æž„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v2.0.0)'
        required: true
        default: 'v2.0.0'

jobs:
  build:
    name: æž„å»ºåº”ç”¨
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            python-version: "3.11"
            artifact-name: "HTTP-Requests-Tool-Windows"
            executable-extension: ".exe"
          - os: ubuntu-latest
            python-version: "3.11"
            artifact-name: "HTTP-Requests-Tool-Linux"
            executable-extension: ""
          - os: macos-latest
            python-version: "3.11"
            artifact-name: "HTTP-Requests-Tool-macOS"
            executable-extension: ".app"

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libegl1-mesa libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt

    - name: è¿è¡Œæž„å»ºè„šæœ¬
      run: python build.py

    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact-name }}
        path: release/${{ matrix.artifact-name }}*
        retention-days: 30

  release:
    name: åˆ›å»ºå‘å¸ƒ
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        path: artifacts

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release-files
        find artifacts -name "*.zip" -o -name "*.tar.gz" | xargs -I {} cp {} release-files/
        ls -la release-files/

    - name: èŽ·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## HTTPè¯·æ±‚å·¥å…· ${{ steps.get_version.outputs.version }}

        ### ðŸŽ‰ æ–°åŠŸèƒ½
        - å…¨æ–°çš„çŽ°ä»£åŒ–ç•Œé¢è®¾è®¡
        - å¼‚æ­¥è¯·æ±‚å¤„ç†ï¼Œé¿å…ç•Œé¢å†»ç»“
        - å®Œæ•´çš„è¯·æ±‚åŽ†å²è®°å½•ç®¡ç†
        - é…ç½®ä¿å­˜å’ŒåŠ è½½åŠŸèƒ½
        - æ™ºèƒ½JSONæ ¼å¼åŒ–
        - è¯¦ç»†çš„å“åº”ä¿¡æ¯æ˜¾ç¤º

        ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        - **Windowsç”¨æˆ·**: ä¸‹è½½ `HTTP-Requests-Tool-Windows.zip`
        - **Linuxç”¨æˆ·**: ä¸‹è½½ `HTTP-Requests-Tool-Linux.tar.gz`
        - **macOSç”¨æˆ·**: ä¸‹è½½ `HTTP-Requests-Tool-macOS.tar.gz`

        ### ðŸš€ ä½¿ç”¨æ–¹æ³•
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
        2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
        3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶å³å¯ä½¿ç”¨

        ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚
        - Windows 10/11 (64ä½)
        - Ubuntu 20.04+ / CentOS 8+ (64ä½)
        - macOS 10.15+ (64ä½)

        ### ðŸ› é—®é¢˜åé¦ˆ
        å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢åé¦ˆã€‚
        EOF

    - name: åˆ›å»ºGitHubå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: HTTPè¯·æ±‚å·¥å…· ${{ steps.get_version.outputs.version }}
        body_path: release_notes.md
        files: release-files/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
